#!/bin/bash
set -e

# ensure pikaur AUR helper is installed
if ! which pikaur; then
    sudo pacman -Syu --needed base-devel git
    cd /tmp
    git clone https://aur.archlinux.org/pikaur.git
    cd pikaur
    makepkg -fsri --noconfirm
fi

# install things that need to exist not to break configs
pikaur -Syu --needed --noconfirm - < ~/.config/yadm/packages

# set up clamav
# fetch virus definitions
sudo freshclam
# set up OnAccessScan
cat ~/.config/yadm/clamav/config | sudo tee -a /etc/clamav/clamd.conf
sudo cp ~/.config/yadm/clamav/virus-event.bash /etc/clamav/
sudo chmod +x /etc/clamav/virus-event.bash
# set clamd to run as root (required for OnAccessScan)
sudo sed -i 's|User clamav|User root|' /etc/clamav/clamd.conf
sudo aa-complain clamd
# enable services
sudo systemctl enable --now clamav-freshclam.service
sudo systemctl enable --now clamav-daemon.service
sudo systemctl enable --now clamav-clamonacc.service

# set up apparmor (for increased security with firejail)
sudo sed -i  's/GRUB_CMDLINE_LINUX=""/GRUB_CMDLINUX_LINUX="lsm=lockdown,yama,apparmor,bpf"/' /etc/default/grub
sudo grub-mkconfig -o /boot/grub/grub.cfg

# add user to useful usergroups
# adm,input,wheel for easy access to inputs and general "admin" stuff
# kvm,libvirt for libvirt KVM virtualization
# audio,realtime for real-time audio privileges
# adbusers for android debug bridge access
sudo usermod -aG adbusers,adm,audio,input,kvm,libvirt,realtime,wheel $USER

# work around host-passthrough KVM bluescreen in win10 versions >=1803
echo "options kvm ignore_msrs=1" | sudo tee /etc/modprobe.d/kvm.conf
echo "options kvm report_ignored_msrs=0" | sudo tee -a /etc/modprobe.d/kvm.conf

# set up libvirt & virt-manager for KVM virtualization
sudo systemctl enable --now libvirtd.service
sudo systemctl start virtlogd.service

# set up rootless buildah & rootless podman
echo "kernel.unprivileged_userns_clone = 1" | sudo tee /etc/sysctl.d/10-rootless-podman.conf
sudo sysctl --system > /dev/null
sudo touch /etc/subuid /etc/subgid
sudo usermod --add-subuids 100000-165536 --add-subgids 100000-165536 $USER

# enable profile-sync-daemon for firefox tmpfs profile sync
echo "$USER ALL=(ALL:ALL) NOPASSWD: /usr/bin/psd-overlay-helper" | sudo tee /etc/sudoers.d/$USER
systemctl --user enable --now psd.service

# set up zoom sandboxing using firejail
cat <<EOF | sudo tee /usr/local/bin/zoom
#!/bin/bash
firejail --profile=/etc/firejail/zoom.profile /opt/zoom/ZoomLauncher $@
EOF
sudo chmod +x /usr/local/bin/zoom
