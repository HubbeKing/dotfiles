#!/bin/bash
set -e

# set up git defaults
# user settings
git config --global user.name HubbeKing
git config --global user.email github@hubbe.club
git config --global init.defaultbranch main
# merge settings
git config --global merge.ff only              # default to just fast-forward
git config --global merge.conflictstyle diff3  # three-way diff on merge conflict
git config --global pull.rebase true           # default to rebase instead of merge commit

# ensure pikaur AUR helper is installed
if ! which pikaur; then
    sudo pacman -Syu --needed base-devel git
    cd /tmp
    git clone https://aur.archlinux.org/pikaur.git
    cd pikaur
    makepkg -fsri --noconfirm
fi

# import gpg keys needed for AUR packages
# python37 / python39
gpg --recv-keys 0D96DF4D4110E5C43FBFB17F2D347EA6AA65421D
# python38 / python39
gpg --recv-keys E3FF2839C048B25C084DEBE9B26995E310250568

# install things that need to exist not to break configs
pikaur -Syu --needed --noconfirm - < ~/.config/yadm/packages

# set up apparmor (for increased security with firejail)
sudo sed -i  's/GRUB_CMDLINE_LINUX=""/GRUB_CMDLINE_LINUX="lsm=landlock,lockdown,yama,apparmor,bpf"/' /etc/default/grub

# add user to useful usergroups
# adm,input,wheel for easy access to inputs and general "admin" stuff
# kvm,libvirt for libvirt KVM virtualization
# audio,realtime for real-time audio privileges
# adbusers for android debug bridge access
sudo usermod -aG adbusers,adm,audio,input,kvm,libvirt,realtime,wheel $USER

# work around host-passthrough KVM bluescreen in win10 versions >=1803
echo "options kvm ignore_msrs=1" | sudo tee /etc/modprobe.d/kvm.conf
echo "options kvm report_ignored_msrs=0" | sudo tee -a /etc/modprobe.d/kvm.conf

# set up libvirt & virt-manager for KVM virtualization
sudo systemctl enable --now libvirtd.service
sudo systemctl start virtlogd.service

# set up rootless buildah & rootless podman
echo "kernel.unprivileged_userns_clone = 1" | sudo tee /etc/sysctl.d/10-rootless-podman.conf
sudo sysctl --system > /dev/null
sudo touch /etc/subuid /etc/subgid
sudo usermod --add-subuids 100000-165536 --add-subgids 100000-165536 $USER
